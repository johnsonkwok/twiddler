<!DOCTYPE html>
<html>
  <head>
    <title>Twiddler</title>
    <meta charset="utf-8">
    <script src="jquery.js"></script>
    <script src="data_generator.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700" rel="stylesheet">
    
    <style>
      body {
        font-family: 'Roboto', Arial, sans-serif;
        padding: 0;
        margin: 0;
      }
      header {
        padding: 15px 0 10px 0;
        border-bottom: 1px solid #dae0e4;
        background-color: #1da1f224;
      }
      .grid {
        display: grid;
        grid-auto-flow: row;
        grid-gap: 1px;
        /* grid-template-columns: 100px 400px; */
      }
      .btn {
        margin: 0 5px;
      }
      #home {
        margin-left: 10px;
      }
      div:first-of-type {
        margin-top: 5px;
      }
      div {
        padding-bottom: 5px;
        margin-left: 12px;
        margin-bottom: 5px;
        border-bottom: 1px solid #f0f4f6;
      }
      p {
        margin: 0 auto;
      }
    </style>

  </head>
  <body>
    <script>

      $(document).ready(function(){
        var $body = $('body');
        let visitor;
        const homeStream = streams.home;
        addHomeTweets();
        
        function addTweets(tweetsArr, idx) {
          var tweet = tweetsArr[idx];
          const timestamp = tweet.created_at.toLocaleTimeString('en-US');
          var $tweet = $('<div></div>');
          const nameDisplay = $('<span></span>').html('<b>' + tweet.user + '</b>');
          nameDisplay.addClass('handle').append(' @' + tweet.user);
          $tweet.prepend(nameDisplay).append('<p>' + tweet.message + '</p>');
          nameDisplay.after('<small> &#8901; ' + timestamp + '</small>');
          $tweet.prependTo('.tweets');
        }

        let currIndex = homeStream.length;
        function addNewTweets() {
          while (currIndex <= homeStream.length - 1) {
            addTweets(homeStream, currIndex);
            currIndex += 1;
            $('#refr').prependTo('header');
            $('#home').prependTo('header');
          }
        }

        function addHomeTweets() {
          $body.html('<header></header><main><section></section><section></section></main>');
          $('section:first').addClass('profile');
          $('section:last').addClass('tweets');
          $('main').addClass('grid');
          var initIndex = 0;
          while (initIndex < homeStream.length) {
            addTweets(homeStream, initIndex);
            initIndex += 1;
          }
          addRefreshBtn();
          addHomeButton();
          createProfile();
        }

        function addRefreshBtn() {
          $('<span></span>').prependTo('header');
          $('header span').attr('id', 'refr').html('<button></button>');
          $('button').text('Refresh Tweets').addClass('btn');;
          $('#refr').click(addNewTweets);
        }

        function addHomeButton() {
          $('<button></button>').text('Home').prependTo('header');
          $('header button:first').addClass('btn').attr('id', 'home');
          $('#home').click(addHomeTweets);
        }

        function displayUserTweets(user) {
          $body.html('<header></header><main><section></section></main>');
          $('section').addClass('tweets');
          $('main').addClass('grid');
          const userStream = streams.users[user];
          let currUserIdx = 0;
          while (currUserIdx < userStream.length) {
            addTweets(userStream, currUserIdx);
            currUserIdx += 1;
          }
          addHomeButton();
        }

        function createProfile() {
          $('.profile').html('<h1></h1><h2></h2><span></span><form></form>');

          if (visitor === undefined) {
            $('form').attr('id', 'user-form').html('<label></label>');
            $('<input><input>').appendTo('#user-form');
            $('#user-form label').attr('for', 'user-id').text('Please enter User ID');
            $('#user-form input:first').attr({
              'type': 'text',
              'id': 'user-id',
              'placeholder': 'enter text here',
              'required': true
            });
            $('#user-form input:last').attr({
              'type': 'submit',
              'value': 'Submit',
              'class': 'btn'
            });
          } else {
            fillProfile();
          }
        }

        function fillProfile() {
          $('.profile h1').text(visitor);
          $('.profile h2').text('@' + visitor);
          $('.profile span').html('&#8862; Joined ' + (new Date()).toUTCString().substring(8, 16));
          $('form').remove();
        }

        $body.on('submit', '#user-form', function() {
          visitor = $('#user-id').val();
          fillProfile();
        });

        $body.on('click', '.handle', function() {
          const userToDisplay = $(this).children('b').text();
          displayUserTweets(userToDisplay);
        });

      });

    </script>
  </body>
</html>
